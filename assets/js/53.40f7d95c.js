(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{398:function(t,a,s){"use strict";s.r(a);var n=s(18),r=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"springboot事务管理学习总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#springboot事务管理学习总结"}},[t._v("#")]),t._v(" springboot事务管理学习总结")]),t._v(" "),s("h2",{attrs:{id:"_1、是否支持事务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1、是否支持事务"}},[t._v("#")]),t._v(" 1、是否支持事务")]),t._v(" "),s("p",[t._v("sqlserver：默认支持事务\nMySQL：默认的存储引擎为MyISAM不支持事务，需要改成InnoDB才能支持事务\n"),s("a",{attrs:{"data-fancybox":"",title:"是否支持事务",href:"https://img-blog.csdnimg.cn/20190515213526424.png"}},[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190515213526424.png",alt:"是否支持事务"}})])]),t._v(" "),s("h2",{attrs:{id:"_2、-enabletransactionmanagement"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2、-enabletransactionmanagement"}},[t._v("#")]),t._v(" 2、@EnableTransactionManagement")]),t._v(" "),s("blockquote",[s("p",[s("code",[t._v("在spring boot")]),t._v("入口函数添加"),s("code",[t._v("@EnableTransactionManagement")]),t._v("注解是否有必要??\n百度了很多都说要在"),s("code",[t._v("springboot")]),t._v("启动加上"),s("code",[t._v("@EnableTransactionManagement")]),t._v("才能生效，但是实际操作中发现"),s("code",[t._v("springboot")]),t._v("是默认开启的，所以不用加此注解")])]),t._v(" "),s("p",[t._v("如下图：springboot启动时就开启了事务配置\n"),s("a",{attrs:{"data-fancybox":"",title:"事务配置",href:"https://img-blog.csdnimg.cn/20190515215007933.png"}},[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190515215007933.png",alt:"事务配置"}})]),t._v(" "),s("a",{attrs:{"data-fancybox":"",title:"事务配置",href:"https://img-blog.csdnimg.cn/20190515215223631.png"}},[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190515215223631.png",alt:"事务配置"}})])]),t._v(" "),s("h2",{attrs:{id:"_3、事务回滚"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3、事务回滚"}},[t._v("#")]),t._v(" 3、事务回滚")]),t._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[t._v("事务回滚的方法")]),t._v(" "),s("ul",[s("li",[t._v("1.基于controller-service-dao三层来写代码，从入口开始，controller层的方法对应的是某个url，面向的是应用人员，应该返回他们能读懂的信息，所以controller必须做异常处理，一般来说会有统一的异常处理方法；")]),t._v(" "),s("li",[t._v("2.service层面向的是controller，service层中的某些方法，必须保证其事务，所以在service层进行事务控制是相当必要的，对于多条sql进行事务控制，如果某个sql执行失败，那么应当对已经执行的sql语句进行回滚；")]),t._v(" "),s("li",[t._v("3.dao层更多是单一的sql语句，没有必要进行事务控制，因为事务开销并不便宜（官方原话）")]),t._v(" "),s("li",[t._v("基于以上三点，一般情况应该把异常网上抛，一直抛到最终处理的那一层，所以对于dao层和service其实是没有必要进行try-catch的，直接往上抛异常就可以。")])])]),t._v(" "),s("blockquote",[s("p",[t._v("与之对应的，是spring的事务配置，默认情况下，spring只对运行时异常进行回滚，如果在dao层处理了异常，那么需要进行额外的配置，spring才会对异常进行回滚，常用的配置是@Transactional(rollbackFor=Exception.class)")])]),t._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"异常进行回滚",href:"https://img-blog.csdnimg.cn/2019051522033043.png"}},[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/2019051522033043.png",alt:"异常进行回滚"}})])]),t._v(" "),s("blockquote",[s("p",[t._v("如果需要在service使用try-catch，则需要手动抛出异常并，设置手动回滚，因为\nSpring的AOP即声明式事务管理默认是针对unchecked exception回滚。也就是默认对RuntimeException()异常或是其子类进行事务回滚；\nchecked异常,即Exception可try{}捕获的不会回滚TransactionAspectSupport.currentTransactionStatus().setRollbackOnly()")])]),t._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"异常进行回滚",href:"https://img-blog.csdnimg.cn/20190515220808514.png"}},[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190515220808514.png",alt:"异常进行回滚"}})])]),t._v(" "),s("p",[t._v("方法A调用方法B事务生效总结")]),t._v(" "),s("p",[t._v("备注:有事务Transactional用√    没有事务用×")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("方法A")]),t._v(" "),s("th",[t._v("方法B")]),t._v(" "),s("th",[t._v("是否事务生效")]),t._v(" "),s("th",[t._v("备注")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("√")]),t._v(" "),s("td",[t._v("√")]),t._v(" "),s("td",[t._v("√")]),t._v(" "),s("td",[t._v("此时事务生效")])]),t._v(" "),s("tr",[s("td",[t._v("√")]),t._v(" "),s("td",[t._v("×")]),t._v(" "),s("td",[t._v("√")]),t._v(" "),s("td",[t._v("此时事务生效")])]),t._v(" "),s("tr",[s("td",[t._v("×")]),t._v(" "),s("td",[t._v("×")]),t._v(" "),s("td",[t._v("×")]),t._v(" "),s("td",[t._v("此时事务不生效")])]),t._v(" "),s("tr",[s("td",[t._v("×")]),t._v(" "),s("td",[t._v("√")]),t._v(" "),s("td",[t._v("×")]),t._v(" "),s("td",[t._v("此时事务不生效")])])])]),t._v(" "),s("h2",{attrs:{id:"_4、第三方事务配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4、第三方事务配置"}},[t._v("#")]),t._v(" 4、第三方事务配置")]),t._v(" "),s("h4",{attrs:{id:"想让事务生效，需要在第三方数据源配置类（druidconfig）中添加如下代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#想让事务生效，需要在第三方数据源配置类（druidconfig）中添加如下代码"}},[t._v("#")]),t._v(" 想让事务生效，需要在第三方数据源配置类（DruidConfig）中添加如下代码")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建第三方数据源事务管理器")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Bean")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DataSourceTransactionManager")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("txManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DataSource")]),t._v(" dataSource"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n           "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DataSourceTransactionManager")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dataSource"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("yml配置说明如下（必须指定第三方数据源的type）\n"),s("a",{attrs:{"data-fancybox":"",title:"yml配置说明",href:"https://img-blog.csdnimg.cn/20190516100558518.png"}},[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190516100558518.png",alt:"yml配置说明"}})])]),t._v(" "),s("p",[t._v("DruidConfig部分代码如下\n"),s("a",{attrs:{"data-fancybox":"",title:"DruidConfig",href:"https://img-blog.csdnimg.cn/201905161008380.png"}},[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/201905161008380.png",alt:"DruidConfig"}})]),t._v(" "),s("a",{attrs:{"data-fancybox":"",title:"DruidConfig",href:"https://img-blog.csdnimg.cn/20190516100924747.png"}},[s("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190516100924747.png",alt:"DruidConfig"}})])]),t._v(" "),s("src-comment")],1)}),[],!1,null,null,null);a.default=r.exports}}]);